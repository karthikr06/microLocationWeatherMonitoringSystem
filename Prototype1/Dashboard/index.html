<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Micro Location Weather monitoring system</title>
    <!-- CSS file -->
    <link rel="stylesheet" href="style.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container mx-auto p-6 md:p-12">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-slate-900">Micro Location Weather monitoring system</h1>
            <p class="text-lg text-slate-600 mt-2">Live data from sensor nodes</p>
            
            <!-- Icon Links Section -->
            <div class="flex justify-center items-center space-x-4 mt-4">
                <a href="https://github.com/karthikr06/microLocationWeatherMonitoringSystem" target="_blank" class="text-slate-500 hover:text-slate-800 transition-colors" aria-label="GitHub Repository">
                    <svg class="w-8 h-8" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                </a>
                <a id="sheetsIconLink" href="#" target="_blank" class="text-slate-500 hover:text-green-600 transition-colors" aria-label="Google Sheets Raw Data">
                    <svg class="w-8 h-8" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><title>Google Sheets</title><path d="M22.5 0H12v11.25h11.25V0zM10.125 0H1.5C.675 0 0 .675 0 1.5v7.125h10.125V0zm0 10.875H0v10.125c0 .825.675 1.5 1.5 1.5h8.625V10.875zm1.875 0V24h9.187c.825 0 1.438-.675 1.438-1.5V10.875H12z"/></svg>
                </a>
            </div>
        </header>

        <!-- Secondary Layer for all content -->
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <!-- Node Selection Buttons -->
            <div class="flex justify-center space-x-4 mb-10">
                <button id="node1Btn" class="px-6 py-3 font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 btn-active" onclick="switchNode(1)">Node 1</button>
                <button id="node2Btn" class="px-6 py-3 font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 bg-slate-200 text-purple-600" onclick="switchNode(2)">Node 2</button>
            </div>

            <!-- Container for all the graphs -->
            <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <!-- Temperature Chart -->
                <div class="bg-orange-100 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-orange-800">Temperature (Â°C)</h2>
                    <div class="relative h-64"><canvas id="tempChart"></canvas></div>
                    <div class="text-center mt-4">
                        <span class="text-lg font-semibold text-orange-800">Current: </span>
                        <span id="currentTemp" class="text-lg font-bold text-orange-900">--</span>
                    </div>
                </div>
                <!-- Humidity Chart -->
                <div class="bg-sky-100 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-sky-800">Humidity (%)</h2>
                    <div class="relative h-64"><canvas id="humidityChart"></canvas></div>
                    <div class="text-center mt-4">
                        <span class="text-lg font-semibold text-sky-800">Current: </span>
                        <span id="currentHumidity" class="text-lg font-bold text-sky-900">--</span>
                    </div>
                </div>
                <!-- Air Quality Chart -->
                <div class="bg-red-100 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-red-800">Air Quality (%)</h2>
                    <div class="relative h-64"><canvas id="airQualityChart"></canvas></div>
                    <div class="text-center mt-4">
                        <span class="text-lg font-semibold text-red-800">Current: </span>
                        <span id="currentAirQuality" class="text-lg font-bold text-red-900">--</span>
                    </div>
                </div>
                <!-- Rainfall Chart -->
                <div class="bg-indigo-100 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-indigo-800">Rainfall (mm)</h2>
                    <div class="relative h-64"><canvas id="rainChart"></canvas></div>
                     <div class="text-center mt-4">
                        <span class="text-lg font-semibold text-indigo-800">Current: </span>
                        <span id="currentRain" class="text-lg font-bold text-indigo-900">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Data Table Section -->
            <div class="bg-slate-50 p-6 rounded-xl">
                <h2 class="text-2xl font-semibold mb-4">Recent Data Log (Last 50 Entries)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-slate-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temperature</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Humidity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Air Quality</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rainfall</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Your Sheet Details ---
        const sheet_id = '2PACX-1vRm1xBo-NBZHMDaLYywNuwwvFANLXLk7ERcIIOTJ6mmc21CBrSairLFevlyTvfs9zr2GbRH_q5A8Ki3';
        const node1_sheet_gid = '0';
        const node2_sheet_gid = '1764542139';
        
        let currentNode = 1; // start with node 1
        let myCharts = {}; // object to hold all charts

        // function to make a new chart
        function createChart(ctx, label, color) {
            return new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color + '33', borderWidth: 2.5, fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false }, x: { ticks: { maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 10 } } }, plugins: { legend: { display: false } } }
            });
        }
        
        // function to make a bar chart for rain
        function createBarChart(ctx, label, color) {
            return new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color, borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }

        // function to get data from google sheet
        async function getData(node) {
            const gid = (node === 1) ? node1_sheet_gid : node2_sheet_gid;
            const url = `https://docs.google.com/spreadsheets/d/e/${sheet_id}/pub?gid=${gid}&single=true&output=csv`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) { throw new Error('Network issue. Check sheet ID and publish settings.'); }
                const csvText = await response.text();
                const data = processData(csvText);
                updatePage(data);
            } catch (error) {
                console.error('Error getting data:', error);
                alert('Could not get data. Check console.');
            }
        }

        // function to process the csv text
        function processData(csvText) {
            const rows = csvText.trim().split('\n');
            const headers = rows.shift().split(',');
            return rows.map(row => {
                const values = row.split(',');
                let obj = {};
                headers.forEach((header, i) => { obj[header.trim()] = values[i] ? values[i].trim() : ''; });
                return obj;
            });
        }

        // function to update the charts and table
        function updatePage(data) {
            if (!data || data.length === 0) return;

            const validData = data.filter(row => row.Timestamp);
            const recentData = validData.slice(-50); 
            const latestEntry = validData[validData.length - 1];

            const labels = recentData.map(row => new Date(row.Timestamp).toLocaleTimeString());
            const tempData = recentData.map(row => parseFloat(row.Temperature));
            const humidityData = recentData.map(row => parseFloat(row.Humidity));
            const airQualityData = recentData.map(row => parseFloat(row['Air Quality'])); // Convert to percentage
            const rainData = recentData.map(row => parseFloat(row.Rainfall));

            updateChartData(myCharts.temp, labels, tempData);
            updateChartData(myCharts.humidity, labels, humidityData);
            updateChartData(myCharts.airQuality, labels, airQualityData);
            updateChartData(myCharts.rain, labels, rainData);

            // Update current value displays
            document.getElementById('currentTemp').innerText = `${parseFloat(latestEntry.Temperature)} Â°C`;
            document.getElementById('currentHumidity').innerText = `${parseFloat(latestEntry.Humidity)} %`;
            document.getElementById('currentAirQuality').innerText = `${parseFloat(latestEntry['Air Quality'])} %`;
            document.getElementById('currentRain').innerText = `${parseFloat(latestEntry.Rainfall)} mm`;

            updateTable(validData);
        }

        // helper to update a single chart
        function updateChartData(chart, labels, data) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }
        
        // update the table with latest 50 entries
        function updateTable(data) {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            const recentDataForTable = data.slice(-50).reverse(); 
            recentDataForTable.forEach(row => {
                const tableRow = `<tr><td class="px-6 py-4 whitespace-nowrap">${new Date(row.Timestamp).toLocaleString()}</td><td class="px-6 py-4 whitespace-nowrap">${row.Temperature} Â°C</td><td class="px-6 py-4 whitespace-nowrap">${row.Humidity} %</td><td class="px-6 py-4 whitespace-nowrap">${parseFloat(row['Air Quality']) * 10} %</td><td class="px-6 py-4 whitespace-nowrap">${row.Rainfall} mm</td></tr>`;
                tableBody.innerHTML += tableRow;
            });
        }

        // handle node switching
        function switchNode(nodeNum) {
            currentNode = nodeNum;
            const node1Btn = document.getElementById('node1Btn');
            const node2Btn = document.getElementById('node2Btn');

            if (nodeNum === 1) {
                node1Btn.classList.add('btn-active');
                node1Btn.classList.remove('bg-slate-200', 'text-purple-600');
                node2Btn.classList.remove('btn-active');
                node2Btn.classList.add('bg-slate-200', 'text-purple-600');
            } else { 
                node1Btn.classList.remove('btn-active');
                node1Btn.classList.add('bg-slate-200', 'text-purple-600');
                node2Btn.classList.add('btn-active');
                node2Btn.classList.remove('bg-slate-200', 'text-purple-600');
            }
            getData(currentNode);
        }
        
        // this runs when the page loads
        window.onload = () => {
            const rawDataUrl = `https://docs.google.com/spreadsheets/d/e/${sheet_id}/pubhtml`;
            document.getElementById('sheetsIconLink').href = rawDataUrl;

            myCharts.temp = createChart(document.getElementById('tempChart').getContext('2d'), 'Temperature', '#F97316');
            myCharts.humidity = createChart(document.getElementById('humidityChart').getContext('2d'), 'Humidity', '#0EA5E9');
            myCharts.airQuality = createChart(document.getElementById('airQualityChart').getContext('2d'), 'Air Quality', '#EF4444');
            myCharts.rain = createBarChart(document.getElementById('rainChart').getContext('2d'), 'Rainfall', '#818CF8');

            getData(currentNode);
            
            setInterval(() => { getData(currentNode); }, 15000);
        };
    </script>
</body>
</html>
